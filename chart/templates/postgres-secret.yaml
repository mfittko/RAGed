{{- $password := required "postgres.password is required; set via --set postgres.password=<secure>" .Values.postgres.password -}}
{{- $encodedUser := replace "+" "%20" (urlquery .Values.postgres.user) -}}
{{- $encodedPassword := replace "+" "%20" (urlquery $password) -}}
{{- $encodedDatabase := replace "+" "%20" (urlquery .Values.postgres.database) -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Release.Name }}-postgres-secret
  labels:
    {{- include "rag.labels" . | nindent 4 }}
type: Opaque
stringData:
  POSTGRES_USER: "{{ .Values.postgres.user }}"
  POSTGRES_PASSWORD: "{{ $password }}"
  # URL encoding for reserved characters. Spaces are normalized to %20 for broad client compatibility.
  DATABASE_URL: "postgresql://{{ $encodedUser }}:{{ $encodedPassword }}@{{ .Release.Name }}-postgres:{{ .Values.postgres.service.port }}/{{ $encodedDatabase }}"
